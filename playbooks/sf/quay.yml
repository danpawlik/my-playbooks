---
- hosts: quay.dev
  vars:
    enable_clair: true
    enable_mirror: true
    fqdn: quay.dev
    self_signed_certs: true
    initial_config: false
    quay_validate_cert: false
    # will be removed soon
    quay_admin_password: password
    quay_users:
      admin:
        email: admin@quay.dev
        password: password
      sf:
        email: sf@quay.dev
        password: password
    database_secret_key: 58995dde-5a37-53a1-ab79-835dfa2bc701
    secret_key: 171e632d-c0a6-56ac-be90-5ee27d283d5d
    postgresql_additional_parameters: "-c shared_buffers=256MB -c max_connections=2000"
    container_images:
      quay: quay.io/projectquay/quay:v3.6.2
      postgresql: quay.io/software-factory/postgres:13.5-alpine3.14
      clair: quay.io/projectquay/clair:4.3.5
      redis: quay.io/software-factory/redis:6.2.4
    quay_enable_prune: true
    quay_api_url: https://quay.dev/api/v1
    quay_insecure: true
    quay_organizations:
      tripleo:
        - name: tripleomastercentos9
          token: ""
          prune_days: 7
        - name: tripleotraincentos8
          token: ""
          prune_days: 7
        - name: tripleotraincentos7
          token: ""
          prune_days: 7
        - name: tripleowallabycentos9
          token: ""
          prune_days: 7
        - name: tripleowallabycentos8
          token: ""
          prune_days: 7
  pre_tasks:
    - name: Disable ipv6
      become: true
      shell: |
        sysctl -w net.ipv6.conf.all.disable_ipv6=1 ; sysctl -w net.ipv6.conf.default.disable_ipv6=1

    - include_role:
        name: hostname

    - name: Install epel-release
      become: true
      package:
        name: epel-release
        state: present
      ignore_errors: true

    - name: Install python3-bcrypt
      become: true
      package:
        name:
          - python3
          - python3-bcrypt
          - python3-cryptography
        state: present

    - name: remove epel-release
      become: true
      package:
        name: epel-release
        state: absent
  tasks:
    - name: Setup quay
      include_role:
        name: quay
        tasks_from: main.yml
    - name: Create organizations
      include_role:
        name: quay-project-creation
        tasks_from: main.yml
