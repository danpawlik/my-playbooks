---
- name: Deploy Kind
  hosts: kind.dev
  vars:
    kind_version: "v0.14.0"
    # curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt
    kubernetes_version: "v1.24.1"
    kompose_version: "v1.26.1"
    kustomize_version: "v4.5.5"
    opm_version: "4.6.1"
    helm_version: "v3.9.0"
    deploy_tools: true
  tasks:
    - name: Install required packages
      become: true
      package:
        name:
          - podman
          - golang
        state: present

    - name: Download kind
      become: true
      get_url:
        url: "https://kind.sigs.k8s.io/dl/{{ kind_version }}/kind-linux-amd64"
        dest: /usr/local/bin/kind
        mode: '0755'

    - name: Download kubectl
      become: true
      get_url:
        url: "https://storage.googleapis.com/kubernetes-release/release/{{ kubernetes_version }}//bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'

    - name: Deploy kind
      become: true
      shell: |
        /usr/local/bin/kind create cluster

    - name: Get kind cluster configuration
      become: true
      shell: |
        mkdir -p ~/.kube/
        kind get kubeconfig > ~/.kube/config
        kubectl completion bash > /etc/bash_completion.d/kubectl

    - name: Download additional tools
      block:
        - name: Download kompose tool
          become: true
          get_url:
            url: "https://github.com/kubernetes/kompose/releases/download/{{ kompose_version }}/kompose-linux-amd64"
            dest: /usr/local/bin/kompose
            mode: '0755'

        - name: Download kustomize tool
          get_url:
            url: "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F{{ kustomize_version }}/kustomize_{{ kustomize_version }}_linux_amd64.tar.gz"
            dest: /tmp/kustomize.tar.gz
            mode: '0644'

        - name: Unpack kustomize
          shell: |
            tar xaf kustomize.tar.gz
          args:
            chdir: /tmp/

        - name: Copy kustomize into the directory
          become: true
          copy:
            src: /tmp/kustomize
            dest: /usr/local/bin/kustomize
            mode: '0755'
            remote_src: true

        - name: Download kubebuilder tool
          become: true
          get_url:
            url: "https://go.kubebuilder.io/dl/latest/linux/amd64"
            dest: /usr/local/bin/kubebuilder
            mode: '0755'

        - name: Download opm tool
          get_url:
            url: "https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/opm/{{ opm_version }}/opm-linux-{{ opm_version }}.tar.gz"
            dest: /tmp/opm.tar.gz
            mode: '0755'

        - name: Unpack opm
          shell: |
            tar xaf opm.tar.gz
          args:
            chdir: /tmp/

        - name: Copy opm into the directory
          become: true
          copy:
            src: /tmp/opm
            dest: /usr/local/bin/opm
            mode: '0755'
            remote_src: true

        - name: Download helm tool
          become: true
          get_url:
            url: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
            dest: /usr/local/bin/helm
            mode: '0755'

        - name: Unpack helm
          shell: |
            tar xaf helm.tar.gz
          args:
            chdir: /tmp/

        - name: Copy helm into the directory
          become: true
          copy:
            src: /tmp/helm
            dest: /usr/local/bin/helm
            mode: '0755'
            remote_src: true

      when: deploy_tools
