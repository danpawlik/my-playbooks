---
- name: Deploy Kind
  hosts: kind.dev
  vars:
    kind_version: "v0.14.0"
    kubernetes_version: "v1.24.1"
    deploy_tools: true
  tasks:
    - name: Install required packages
      become: true
      package:
        name:
          - podman
          - golang
        state: present

#    # Use sf-infra kind role to deploy Kind
#    - include_role:
#        name: kind

    - name: Download kind
      become: true
      get_url:
        url: "https://kind.sigs.k8s.io/dl/{{ kind_version }}/kind-linux-amd64"
        dest: /usr/local/bin/kind
        mode: '0755'

    - name: Download kubectl
      become: true
      get_url:
        url: "https://storage.googleapis.com/kubernetes-release/release/{{ kubernetes_version }}/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'

    - name: Deploy kind
      become: true
      shell: |
        /usr/local/bin/kind create cluster &> /root/kind-cluster-log

    - name: Get kind cluster configuration
      become: true
      shell: |
        mkdir -p ~/.kube/
        kind get kubeconfig > ~/.kube/config
        /usr/local/bin/kubectl completion bash > /etc/bash_completion.d/kubectl
        echo "export PATH=\$PATH:/usr/local/bin" >> ~/.bashrc

    - name: Download additional tools
      include_tasks: k8s-tools.yaml
      when: deploy_tools
